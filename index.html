<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curvas de Bombas - MSbombas.cl</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(to right, #005baa, #00b36b);
      color: #fff;
      min-height: 100vh;
    }
    header {
      text-align: center;
      padding: 20px;
      font-size: 2rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.2);
    }
    .top-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      width: 90%;
      max-width: 1100px;
      margin: 20px auto;
      gap: 20px;
    }
    .selector {
      flex: 1;
      background: #fff;
      color: #000;
      border-radius: 10px;
      padding: 20px;
      min-width: 280px;
      max-width: 450px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    select {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
    }
    .imagen-container {
      flex: 1;
      text-align: center;
      min-width: 280px;
    }
    .imagen-container img {
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      border: 4px solid #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .imagen-container h3 {
      margin-bottom: 10px;
      color: #fff;
      font-weight: normal;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .plot {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      color: #000;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    footer {
      text-align: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>CURVAS DE BOMBAS - MSbombas.cl</header>

  <div class="top-container">
    <div class="selector">
      <label>Serie:</label>
      <select id="serieSelect"></select>

      <label>Modelo:</label>
      <select id="modeloSelect"></select>

      <div id="rpmContainer" style="display:none;">
        <label>RPM:</label>
        <select id="rpmSelect">
          <option value="1450">1450</option>
          <option value="2900">2900</option>
        </select>
      </div>
    </div>

    <div class="imagen-container">
      <h3 id="tituloImagen">Seleccione una serie</h3>
      <img id="imagenSerie" src="" alt="Imagen de bomba" style="display:none;">
    </div>
  </div>

  <div class="grid">
    <div id="graficoAltura" class="plot"></div>
    <div id="graficoPotencia" class="plot"></div>
    <div id="graficoNPSH" class="plot"></div>
    <div id="graficoEficiencia" class="plot"></div>
  </div>

  <footer>Muy importante: si el motor es a combustión (diésel o bencinero), la potencia debe incrementarse un 25%.</footer>

  <script>
    const jsonURL = "https://zuriciver-web.github.io/web-mecanica/bombas.json";

    let dataGlobal;

    fetch(jsonURL)
      .then(res => res.json())
      .then(data => {
        dataGlobal = data.series;
        cargarSeries();
      });

    const serieSelect = document.getElementById("serieSelect");
    const modeloSelect = document.getElementById("modeloSelect");
    const rpmContainer = document.getElementById("rpmContainer");
    const rpmSelect = document.getElementById("rpmSelect");
    const imagenSerie = document.getElementById("imagenSerie");
    const tituloImagen = document.getElementById("tituloImagen");

    function cargarSeries() {
      serieSelect.innerHTML = '<option value="">Seleccione Serie</option>';
      dataGlobal.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.nombre;
        opt.textContent = s.nombre;
        serieSelect.appendChild(opt);
      });
    }

    serieSelect.addEventListener("change", () => {
      const serie = dataGlobal.find(s => s.nombre === serieSelect.value);
      modeloSelect.innerHTML = '<option value="">Seleccione Modelo</option>';
      if (serie) {
        serie.modelos.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.codigo;
          opt.textContent = m.codigo;
          modeloSelect.appendChild(opt);
        });
        // Mostrar imagen de la serie
        imagenSerie.src = serie.imagen;
        imagenSerie.style.display = "block";
        tituloImagen.textContent = `Serie ${serie.nombre} - Referencia Visual`;
      } else {
        imagenSerie.style.display = "none";
        tituloImagen.textContent = "Seleccione una serie";
      }
      limpiarGraficos();
    });

    modeloSelect.addEventListener("change", () => {
      const serie = dataGlobal.find(s => s.nombre === serieSelect.value);
      const modelo = serie.modelos.find(m => m.codigo === modeloSelect.value);
      if (!modelo) return;

      if (modelo.codigo === "CB-100") {
        rpmContainer.style.display = "block";
      } else {
        rpmContainer.style.display = "none";
      }

      dibujarGraficos(modelo);
    });

    rpmSelect.addEventListener("change", () => {
      const serie = dataGlobal.find(s => s.nombre === serieSelect.value);
      const modelo = serie.modelos.find(m => m.codigo === modeloSelect.value);
      dibujarGraficos(modelo);
    });

    function limpiarGraficos() {
      ["graficoAltura","graficoPotencia","graficoNPSH","graficoEficiencia"].forEach(id=>{
        Plotly.purge(id);
      });
    }

    function dibujarGraficos(modelo) {
      limpiarGraficos();

      let dataAltura = [], dataPotencia = [], dataNPSH = [], dataEficiencia = [];

      let motor = modelo;
      if (modelo.codigo === "CB-100") {
        const rpm = rpmSelect.value;
        motor = modelo.rpm[rpm];
      }

      if (!motor) return;

      motor.diametros.forEach((d,i) => {
        const color = `hsl(${i*60}, 70%, 45%)`;

        dataAltura.push({
          x: d.curvas.caudal_lmin,
          y: d.curvas.altura_m,
          mode: 'lines+markers',
          name: `${d.mm} mm`,
          line: { color, shape: 'spline', width: 2 }
        });

        dataPotencia.push({
          x: d.curvas.caudal_lmin,
          y: d.curvas.potencia_hp,
          mode: 'lines+markers',
          name: `${d.mm} mm`,
          line: { color, shape: 'spline', width: 2 }
        });
      });

      if (motor.npsh) {
        dataNPSH.push({
          x: motor.npsh.caudal_lmin,
          y: motor.npsh.npsh_m,
          mode: 'lines+markers',
          name: "NPSH",
          line: { color: '#FF3333', shape: 'spline', width: 2 }
        });
      }

      if (motor.eficiencia) {
        dataEficiencia.push({
          x: motor.diametros[0].curvas.caudal_lmin,
          y: motor.eficiencia,
          mode: 'lines+markers',
          name: "Eficiencia",
          line: { color: '#00ff99', shape: 'spline', width: 2 }
        });
      }

      Plotly.newPlot('graficoAltura', dataAltura, { title: "Altura vs Caudal (m - L/min)", paper_bgcolor: 'white', plot_bgcolor: 'white', font:{color:'black'} });
      Plotly.newPlot('graficoPotencia', dataPotencia, { title: "Potencia vs Caudal (HP - L/min)", paper_bgcolor: 'white', plot_bgcolor: 'white', font:{color:'black'} });
      Plotly.newPlot('graficoNPSH', dataNPSH, { title: "NPSH (m) vs Caudal (L/min)", paper_bgcolor: 'white', plot_bgcolor: 'white', font:{color:'black'} });
      Plotly.newPlot('graficoEficiencia', dataEficiencia, { title: "Eficiencia (%) vs Caudal (L/min)", paper_bgcolor: 'white', plot_bgcolor: 'white', font:{color:'black'} });
    }
  </script>
</body>
</html>
