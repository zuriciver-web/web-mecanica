<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSbombas.cl - Catálogo Interactivo</title>
  <link rel="icon" type="image/x-icon" href="img/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #ffffff;
      color: #333;
      text-align: center;
    }

    header {
      background-color: #004080;
      color: white;
      padding: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
    }

    .selector-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin: 20px 0;
    }

    select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    #imagen-bomba {
      max-width: 300px;
      margin: 20px auto;
      display: block;
    }

    canvas {
      max-width: 700px;
      margin: 20px auto;
      display: block;
      background: #f8f8f8;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .nota {
      color: red;
      font-weight: bold;
      margin: 20px auto;
    }

    footer {
      background-color: #f2f2f2;
      color: #555;
      padding: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>MSbombas.cl - Catálogo de Bombas</h1>
  </header>

  <div class="selector-container">
    <select id="serieSelect">
      <option value="">Seleccione Serie</option>
    </select>

    <select id="modeloSelect" disabled>
      <option value="">Seleccione Modelo</option>
    </select>

    <select id="diametroSelect" disabled>
      <option value="">Seleccione Diámetro de Impulsor</option>
    </select>

    <select id="rpmSelect" style="display:none;">
      <option value="1450">1450 RPM</option>
      <option value="2900">2900 RPM</option>
    </select>
  </div>

  <img id="imagen-bomba" src="" alt="Imagen de bomba">

  <canvas id="graficoAltura"></canvas>
  <canvas id="graficoPotencia"></canvas>
  <canvas id="graficoNPSH"></canvas>
  <canvas id="graficoEficiencia"></canvas>

  <p class="nota">
    ⚠️ Muy Importante: Si el motor es a combustión (diésel o bencinero), la potencia debe aumentarse en un 25%.
  </p>
  <script>
    let data;
    let chartAltura, chartPotencia, chartNPSH, chartEficiencia;

    async function cargarDatos() {
      const response = await fetch('bombas.json');
      data = await response.json();
      inicializarSelectores();
    }

    function inicializarSelectores() {
      const serieSelect = document.getElementById('serieSelect');
      data.series.forEach(serie => {
        const opt = document.createElement('option');
        opt.value = serie.nombre;
        opt.textContent = serie.nombre;
        serieSelect.appendChild(opt);
      });

      serieSelect.addEventListener('change', actualizarModelos);
      document.getElementById('modeloSelect').addEventListener('change', actualizarDiametros);
      document.getElementById('diametroSelect').addEventListener('change', actualizarGraficos);
      document.getElementById('rpmSelect').addEventListener('change', actualizarGraficos);
    }

    function actualizarModelos() {
      const serieNombre = document.getElementById('serieSelect').value;
      const serie = data.series.find(s => s.nombre === serieNombre);
      const modeloSelect = document.getElementById('modeloSelect');
      const img = document.getElementById('imagen-bomba');
      modeloSelect.innerHTML = '<option value="">Seleccione Modelo</option>';

      if (!serie) return;
      serie.modelos.forEach(modelo => {
        const opt = document.createElement('option');
        opt.value = modelo.codigo;
        opt.textContent = modelo.codigo;
        modeloSelect.appendChild(opt);
      });

      document.getElementById('modeloSelect').disabled = false;
      img.src = serie.imagen;
      document.getElementById('diametroSelect').disabled = true;
    }

    function actualizarDiametros() {
      const serieNombre = document.getElementById('serieSelect').value;
      const modeloCodigo = document.getElementById('modeloSelect').value;
      const serie = data.series.find(s => s.nombre === serieNombre);
      const modelo = serie.modelos.find(m => m.codigo === modeloCodigo);
      const diametroSelect = document.getElementById('diametroSelect');
      const rpmSelect = document.getElementById('rpmSelect');
      diametroSelect.innerHTML = '<option value="">Seleccione Diámetro</option>';

      rpmSelect.style.display = "none";

      let modeloActivo = modelo;
      if (modelo.rpm && !Array.isArray(modelo.rpm)) {
        rpmSelect.style.display = "inline-block";
        const rpmSeleccionada = rpmSelect.value || "2900";
        modeloActivo = modelo.rpm[rpmSeleccionada];
      }

      if (!modeloActivo.diametros) return;

      modeloActivo.diametros.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.mm;
        opt.textContent = d.mm + " mm";
        diametroSelect.appendChild(opt);
      });

      document.getElementById('diametroSelect').disabled = false;
    }

    function actualizarGraficos() {
      const serieNombre = document.getElementById('serieSelect').value;
      const modeloCodigo = document.getElementById('modeloSelect').value;
      const serie = data.series.find(s => s.nombre === serieNombre);
      const modelo = serie.modelos.find(m => m.codigo === modeloCodigo);
      const rpmSelect = document.getElementById('rpmSelect');
      const rpm = modelo.rpm ? rpmSelect.value : modelo.rpm;
      let modeloActivo = modelo.rpm && !Array.isArray(modelo.rpm) ? modelo.rpm[rpm] : modelo;

      const diametros = modeloActivo.diametros;
      const npsh = modeloActivo.npsh;
      const eficiencia = modeloActivo.eficiencia || [70, 75, 80, 78, 74];

      const colores = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)'
      ];

      const datasetsAltura = diametros.map((d, i) => ({
        label: `Ø ${d.mm} mm`,
        data: d.curvas.caudal_lmin.map((c, j) => ({ x: c, y: d.curvas.altura_m[j] })),
        borderColor: colores[i % colores.length],
        fill: false,
        tension: 0.4
      }));

      const datasetsPotencia = diametros.map((d, i) => ({
        label: `Ø ${d.mm} mm`,
        data: d.curvas.caudal_lmin.map((c, j) => ({ x: c, y: d.curvas.potencia_hp[j] })),
        borderColor: colores[i % colores.length],
        fill: false,
        tension: 0.4
      }));

      const datasetNPSH = [{
        label: 'NPSH (m)',
        data: npsh.caudal_lmin.map((c, i) => ({ x: c, y: npsh.npsh_m[i] })),
        borderColor: 'rgba(255, 159, 64, 1)',
        fill: false,
        tension: 0.4
      }];

      const datasetEficiencia = [{
        label: 'Eficiencia (%)',
        data: diametros[0].curvas.caudal_lmin.map((c, i) => ({ x: c, y: eficiencia[i] })),
        borderColor: 'rgba(0, 128, 0, 1)',
        fill: false,
        tension: 0.4
      }];

      renderChart('graficoAltura', 'Altura (m)', 'Caudal (L/min)', datasetsAltura);
      renderChart('graficoPotencia', 'Potencia (HP)', 'Caudal (L/min)', datasetsPotencia);
      renderChart('graficoNPSH', 'NPSH (m)', 'Caudal (L/min)', datasetNPSH);
      renderChart('graficoEficiencia', 'Eficiencia (%)', 'Caudal (L/min)', datasetEficiencia);
    }

    function renderChart(canvasId, labelY, labelX, datasets) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (window[canvasId]) window[canvasId].destroy();

      window[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: labelX } },
            y: { title: { display: true, text: labelY } }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }

    window.onload = cargarDatos;
  </script>
  <footer>
    © 2025 MSbombas.cl — Ingeniería en Bombeo y Soluciones Hidráulicas<br>
    Diseñado para ofrecer información técnica precisa sobre modelos, curvas y rendimientos.
  </footer>
</body>
</html>
